--liquibase formatted sql

--changeset ebudoskij:1
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    email VARCHAR(254) UNIQUE NOT NULL,
    password_hash VARCHAR(100) NOT NULL,
    full_name VARCHAR(255) NOT NULL,
    phone_number VARCHAR(20),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

--changeset ebudoskij:2
CREATE TABLE roles (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    name VARCHAR(20) UNIQUE NOT NULL
);

--changeset ebudoskij:3
CREATE TABLE users_roles (
    user_id BIGINT NOT NULL,
    role_id BIGINT NOT NULL,
    PRIMARY KEY (user_id, role_id),

    CONSTRAINT fk_user_role_role_id FOREIGN KEY (role_id) REFERENCES roles(id),
    CONSTRAINT fk_user_role_user_id FOREIGN KEY (user_id) REFERENCES users(id)
);

--changeset ebudoskij:4
CREATE TABLE categories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    parent_id BIGINT,
    name VARCHAR(100) UNIQUE NOT NULL,
    description VARCHAR(500),

    CONSTRAINT fk_category_parent_id FOREIGN KEY (parent_id) REFERENCES categories(id)
);

--changeset ebudoskij:5
CREATE TABLE products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    category_id BIGINT NOT NULL,
    name VARCHAR(200) NOT NULL,
    description VARCHAR(500),
    price_per_unit DECIMAL(10, 2),
    unit_type VARCHAR(20),

    CONSTRAINT fk_product_category_id FOREIGN KEY (category_id) REFERENCES categories(id)
);

--changeset ebudoskij:6
CREATE TABLE additional_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    name VARCHAR(200) UNIQUE NOT NULL,
    description VARCHAR(500),
    extra_price DECIMAL(10, 2) NOT NULL
);

--changeset ebudoskij:7
CREATE TABLE media (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id BIGINT NOT NULL,
    url VARCHAR(255) NOT NULL,
    priority INTEGER
);
CREATE INDEX idx_media_entity ON media(entity_type, entity_id);

--changeset ebudoskij:8
CREATE TABLE order_statuses (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    name VARCHAR(50) UNIQUE NOT NULL
);

--changeset ebudoskij:9
CREATE TABLE orders (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    user_id BIGINT NOT NULL,
    status_id BIGINT NOT NULL,
    delivery_address VARCHAR(200) NOT NULL,
    delivery_date TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    CONSTRAINT fk_order_user_id FOREIGN KEY (user_id) REFERENCES users(id),
    CONSTRAINT fk_order_status_id FOREIGN KEY (status_id) REFERENCES order_statuses(id)
);

--changeset ebudoskij:10
CREATE TABLE order_items (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    additional_item_id BIGINT,
    quantity INTEGER NOT NULL,
    price_at_purchase DECIMAL(10, 2) NOT NULL,

    CONSTRAINT fk_order_item_product_id FOREIGN KEY (product_id) REFERENCES products(id),
    CONSTRAINT fk_order_item_additional_item_id FOREIGN KEY (additional_item_id) REFERENCES additional_items(id),
    CONSTRAINT fk_order_item_order_id FOREIGN KEY (order_id) REFERENCES orders(id)
);
CREATE INDEX idx_order_items_order_id ON order_items(order_id);

--changeset ebudoskij:11
CREATE TABLE payments (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    order_id BIGINT NOT NULL,
    amount DECIMAL(10, 2) NOT NULL,
    payment_method VARCHAR(100) NOT NULL,
    payment_status VARCHAR(20) NOT NULL,
    payment_type VARCHAR(20) NOT NULL,
    transaction_id VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    CONSTRAINT fk_payment_order_id FOREIGN KEY (order_id) REFERENCES orders(id)
);
CREATE INDEX idx_payments_order_id ON payments(order_id);

--changeset ebudoskij:12
CREATE TABLE audit_log (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY NOT NULL,
    order_id BIGINT,
    payment_id BIGINT,
    action_type VARCHAR(50) NOT NULL,
    details VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,

    CONSTRAINT fk_audit_log_order_id FOREIGN KEY (order_id) REFERENCES orders(id),
    CONSTRAINT fk_audit_log_payment_id FOREIGN KEY (payment_id) REFERENCES payments(id)
);


